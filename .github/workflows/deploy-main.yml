# .github/workflows/deploy-main.yml
name: Deploy React to NCP Server

on:
  push:
    branches:
      - main
    # í•´ë‹¹ ê²½ë¡œì— í¬í•¨ë˜ëŠ” í•­ëª©ì´ updateëœ ê²½ìš° ì—…ë°ì´íŠ¸
    paths:
      - '**/*.js'
      - 'public/**'
      - 'src/**'
      - '.github/workflows/**'
      - 'package.json'
      - 'webpack.config.*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Git Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 3. í™˜ê²½ë³€ìˆ˜ ì£¼ì…
      - name: Create .env.production
        run: |
          echo "REACT_APP_MZ_OFFICE_WEB_URL=${{ secrets.REACT_APP_MZ_OFFICE_WEB_URL }}" >> .env.production
          echo "REACT_APP_MZ_OFFICE_SERVER_URL=${{ secrets.REACT_APP_MZ_OFFICE_SERVER_URL }}" >> .env.production
          echo "REACT_APP_NAVER_CLIENT_ID=${{ secrets.REACT_APP_NAVER_CLIENT_ID }}" >> .env.production
          echo "REACT_APP_NAVER_CLIENT_SECRET=${{ secrets.REACT_APP_NAVER_CLIENT_SECRET }}" >> .env.production
          echo "REACT_APP_SERVICE_DESCRIPTION_URL=${{ secrets.REACT_APP_SERVICE_DESCRIPTION_URL }}" >> .env.production

      # 4. í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build project
        run: npm run build

      # 5. SSH Key ì €ì¥
      - name: Save SSH Key
        run: |
          echo "${{ secrets.NCP_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # 6. ê¸°ì¡´ íŒŒì¼ ë°±ì—… (ë°°í¬ ì „)
      - name: Backup existing deployment to home directory
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }} "\
            if [ -d /var/www/mz-office ]; then \
              mkdir -p ~/backups && \
              cp -r /var/www/mz-office ~/backups/mz-office-backup-$(date +%Y%m%d%H%M%S); \
              echo 'ğŸ›¡ Backup completed.'; \
            else \
              echo 'â„¹ï¸ No existing deployment found. Skipping backup.'; \
            fi"

      # 7. ì‹¤ì œ ë°°í¬
      - name: Deploy via SCP to NCP server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_USER }}
          key: ${{ secrets.NCP_SSH_KEY }}
          source: "dist/"
          target: "/var/www/mz-office"
          overwrite: true
          debug: true # ë¡œê·¸ì— sshê³„ì •, í¬íŠ¸ ë“± ì¶œë ¥í•˜ëŠ” debug ëª¨ë“œ í™œì„±í™”
            
      # 8. ë°°í¬ ì‹¤íŒ¨ ì‹œ ë³µì›
      - name: Restore from backup if deploy fails
        if: failure()
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }} "\
            if [ -d ~/backups ]; then \
              latest=\$(ls -td ~/backups/mz-office-backup-* | head -n 1) && \
              if [ -n \"\$latest\" ]; then \
                rm -rf /var/www/mz-office && \
                cp -r \$latest /var/www/mz-office && \
                echo 'âœ… Restored from:' \$latest; \
              else \
                echo 'âš ï¸ No backup found to restore.'; \
              fi \
            else \
              echo 'âš ï¸ No backups directory found.'; \
            fi"

      # 9. ì„±ê³µ ì‹œ ë°±ì—… ì •ë¦¬
      - name: Remove backups after successful deployment
        if: success()
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.NCP_USER }}@${{ secrets.NCP_HOST }} "\
            rm -rf ~/backups && \
            echo 'ğŸ§¹ Removed all backup files after successful deployment.'"